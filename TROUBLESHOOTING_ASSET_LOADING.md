# Troubleshooting Guide: Asset Loading 404 Errors

## Problem Symptoms
- ❌ Product images show as broken icons in Ghost Cards
- ❌ Browser console shows: `Failed to load resource: the server responded with a status of 404`
- ❌ Requests like `/static/assets/products/akai-professional-mpc-one-plus.webp` return 404

## Root Cause
The asset harvesting script has not been executed. While the infrastructure (Vite proxy, FastAPI mount) is correctly configured, the actual image files don't exist on disk.

### Why This Happens
1. Catalog JSON files reference product images with paths like `/static/assets/products/{product-id}.webp`
2. These files must be generated by running `backend/scripts/harvest_assets.py`
3. If the script has never been run or was run with incomplete assets, images will be missing
4. Browser requests for missing files = 404 errors

---

## Solution: 4 Simple Steps

### Step 1: Install Image Processing Library
```bash
pip install Pillow
```
This library is required to generate and optimize placeholder images.

### Step 2: Run Asset Harvester
```bash
cd /workspaces/hsc-jit-v3/backend
python scripts/harvest_assets.py
```

**What it does:**
- Scans all 90+ catalog JSON files
- For each product/brand, attempts to download images from URLs in the catalog
- Creates placeholder images where downloads fail (most will - URLs are often outdated)
- Updates catalog JSON files to point to local `/static/` paths
- Generates 300+ product images and 90+ brand logos

**Expected output:**
```
INFO:__main__:Harvest complete. Logos saved: X | Product images saved: Y
```

### Step 3: Restart Backend ⚠️ CRITICAL
```bash
# If running locally:
# IMPORTANT: The harvest script updates JSON files, but the backend caches them in memory.
# You MUST restart the backend to reload the updated catalog data.

pkill -f "uvicorn"  # Kill existing backend
sleep 2              # Wait for clean shutdown
cd /workspaces/hsc-jit-v3/backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# If using Docker:
docker-compose restart backend
```

**Why this is critical:**
- CatalogService loads JSON files into memory at startup
- Harvest script modifies the JSON files on disk
- Backend must be restarted to pick up the changes
- If you don't restart, the backend will still serve old image URLs

### Step 4: Restart Frontend
```bash
# If running locally:
cd /workspaces/hsc-jit-v3/frontend
pnpm dev

# If using Docker:
docker-compose restart frontend
```

---

## Verification Checklist

After completing the steps above, verify each point:

- [ ] Files exist: `ls /workspaces/hsc-jit-v3/backend/app/static/assets/products/ | wc -l`
  - Should show **340+** files
  
- [ ] Backend serves files directly:
  ```bash
  curl -I http://localhost:8000/static/assets/products/akai-professional-mpc-one-plus.webp
  # Should return: HTTP/1.1 200 OK
  ```

- [ ] Frontend proxy works:
  ```bash
  curl -I http://localhost:5173/static/assets/products/akai-professional-mpc-one-plus.webp
  # Should return: HTTP/1.1 200 OK
  ```

- [ ] Browser test:
  1. Open http://localhost:5173
  2. Search for "Akai MPC" or "Roland TD"
  3. Ghost Card appears WITHOUT broken image icon
  4. DevTools console shows NO 404 errors

---

## Advanced: Re-generate Assets

If you want to completely regenerate all assets from scratch:

```bash
cd /workspaces/hsc-jit-v3/backend

# Remove existing assets
rm -rf app/static/assets/products/*
rm -rf app/static/assets/brands/*

# Re-run harvester
python scripts/harvest_assets.py
```

---

## Why Placeholders Are OK

The system uses placeholder images (gray boxes with product names) for the following reasons:

1. **Original URLs are often broken** - Many external image URLs become invalid over time
2. **Graceful fallback** - Users never see broken images, just branded placeholders
3. **Searchable** - Product names appear on placeholders, maintaining usability
4. **Development friendly** - Developers can work without external dependencies

In production, you would:
- Use CDN-hosted images
- Implement your own image download pipeline
- Cache images more aggressively

---

## Port Management Issues

### "Port 5173 is in use"
This happens when multiple instances of the dev server try to run simultaneously.

**Symptoms:**
```
Port 5173 is in use, trying another one...
VITE v7.3.1 ready in 260 ms
➜ Local: http://localhost:5174/
```

**Solution:**
```bash
# Kill all pnpm processes
pkill -f "pnpm"
pkill -f "node"

# Wait for cleanup
sleep 2

# Restart frontend
cd /workspaces/hsc-jit-v3/frontend
pnpm dev
```

**Prevention:**
- Check running processes: `ps aux | grep pnpm`
- Always kill frontend before restarting
- Use the branch-manager tool: `bash tools/branch-manager.sh purify`

### "Frontend serving on 5174 instead of 5173"
This is normal behavior when port 5173 is already in use.

**Action:**
Simply use the port that's serving (5174, 5175, etc.). The proxy configuration works on any port.

```bash
# Open in browser
http://localhost:5174  # or whatever port Vite assigned
```

---

## Common Issues & Solutions

### "Images still showing broken icons after running harvest_assets.py"
**Root Cause:** Backend wasn't restarted after the harvest script

The backend caches catalog JSON in memory at startup. When you run `harvest_assets.py`, it updates the JSON files on disk, but the running backend is still using the old in-memory data.

**Solution:**
```bash
# Kill the backend
pkill -f "uvicorn"
sleep 2

# Restart it fresh
cd /workspaces/hsc-jit-v3/backend
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000

# You should see: "[CatalogService] Loaded 340 products from 90 rich brands."
# This confirms it reloaded the catalogs from disk with the updated paths
```

### "Module not found: PIL"
```bash
pip install Pillow
```

### "Harvest script creates 0 images"
This is normal if all URLs are broken. The script still creates placeholders. Check:
```bash
ls /workspaces/hsc-jit-v3/backend/app/static/assets/products/ | head -10
# Should list .webp files even if they're just placeholders
```

### "Images still 404 after harvest"
1. Did you restart the backend? `pkill uvicorn` then restart
2. Did you clear browser cache? `Ctrl+Shift+Delete`
3. Check file permissions: `chmod -R 755 /workspaces/hsc-jit-v3/backend/app/static`

### "Proxy returns 404 but backend returns 200"
This usually means Vite dev server isn't reloading the config. Restart frontend:
```bash
pkill -f "pnpm dev"
cd /workspaces/hsc-jit-v3/frontend && pnpm dev
```

---

## Prevention: Initialization Checklist

To prevent this issue in future deployments, ensure this is part of your setup process:

```bash
#!/bin/bash
# Setup script for HSC JIT v3

# 1. Install dependencies
pip install -r backend/requirements.txt
pip install Pillow  # Critical for asset harvesting

# 2. Generate assets
cd backend
python scripts/harvest_assets.py

# 3. Start services
cd ..
# ... start your services ...
```

---

## Why This Wasn't Caught Earlier

The investigation report correctly identified that:
- ✅ Vite proxy was configured
- ✅ FastAPI mount was in place
- ✅ Infrastructure was sound

**But it didn't check:**
- ❌ Whether the asset harvester had been run
- ❌ Whether image files actually existed on disk

This is a classic case where infrastructure is perfect but initialization is incomplete.

---

## Related Documentation

- **Full technical analysis:** `ASSET_LOADING_ISSUE_AND_FIX.md`
- **System status:** `SYSTEM_STATUS.md`
- **Architecture guide:** `docs/architecture/ARCHITECTURE.md`
- **Operations runbook:** `docs/operations/RUNBOOK.md`
