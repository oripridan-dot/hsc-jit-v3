#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

# HSC-JIT v3.7.4 - Pre-commit Quality Gate
# Prevents commits with quality issues

echo "ðŸ” Running pre-commit quality checks..."

cd frontend

# 1. TypeScript compilation
echo "  â†’ TypeScript compilation..."
pnpm exec tsc --noEmit || {
  echo "âŒ TypeScript errors found. Fix before committing."
  exit 1
}

# 2. ESLint
echo "  â†’ ESLint..."
pnpm exec eslint src --max-warnings 0 || {
  echo "âŒ ESLint errors found. Fix before committing."
  exit 1
}

# 3. Check for console.log in new code (not devTools)
echo "  â†’ Checking for console.log..."
git diff --cached --name-only | grep -E "src/.*\.(ts|tsx)$" | grep -v "devTools" | while read file; do
  if git diff --cached "$file" | grep -E "^\+.*console\.(log|debug)" > /dev/null; then
    echo "âŒ console.log found in $file"
    exit 1
  fi
done

# 4. Check for TODO/FIXME in committed code
echo "  â†’ Checking for TODO/FIXME..."
if git diff --cached | grep -E "^\+.*\b(TODO|FIXME)\b"; then
  echo "âš ï¸  Warning: New TODO/FIXME added. Consider addressing before commit."
  # Don't block, just warn
fi

# 5. Check for non-existent imports (basic check)
echo "  â†’ Checking imports..."
git diff --cached --name-only | grep -E "\.tsx?$" | while read file; do
  if [ -f "$file" ]; then
    # Check for imports from deleted files
    grep -o "from ['\"]\..*['\"]" "$file" 2>/dev/null | while read import; do
      path=$(echo "$import" | sed "s/from ['\"]//;s/['\"]//g")
      # Basic validation - full validation done by TypeScript
    done
  fi
done

echo "âœ… All pre-commit checks passed!"
